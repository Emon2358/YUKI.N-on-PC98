name: Build PC-98 Floppy Image (Fixed Boot)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Create Assembly Source (UTF-8)
        run: |
          cat << 'EOF' > source_utf8.asm
          cpu 8086
          org 0x0000       ; オフセットは0から開始

          section .text
          start:
              ; --- 重要: セグメント初期化 ---
              ; PC-98のBIOSは IPLを 1FC0:0000 にロードして実行します。
              ; CSはすでに 1FC0 になっています。
              ; データ(メッセージ)を正しく読むために DS を CS と同じにします。
              
              cli             ; 割り込み禁止
              mov ax, cs
              mov ds, ax
              mov es, ax
              mov ss, ax
              mov sp, 0xFFFE  ; スタックをセグメント末尾に設定
              sti             ; 割り込み許可

              ; --- 画面の初期化 (必須) ---
              ; 400ライン/200ラインモードの正規化
              mov ah, 0x0A
              mov al, 0x00    ; 機能を要求
              int 0x18
              
              ; 画面クリア (VRAMクリア)
              mov ah, 0x16
              mov dx, 0       ; コマンド 0:All Clear
              int 0x18

              ; カーソルを表示ONにする
              mov ah, 0x13
              mov dx, 1       ; 1 = 表示ON
              mov cx, 0x0000  ; カーソル位置 (0,0)
              int 0x18
              
              ; カーソル位置を明示的に (0,0) へセット
              mov ah, 0x13
              mov dx, 0       ; 0 = 位置設定
              mov cx, 0x0000
              int 0x18

              ; --- メッセージ表示ループ ---
              mov si, message_data
          
          char_loop:
              lodsb           ; AL = [DS:SI], SI++
              or al, al       ; NULL終端チェック
              jz wait_enter   ; 0ならループ終了

              ; --- 1文字表示 ---
              mov ah, 0x40    ; TEXT WRITE
              mov bx, 0       ; Page 0
              int 0x18
              
              ; --- ウェイト (文字送り演出) ---
              call delay_char

              jmp char_loop

          wait_enter:
              ; --- 入力待ち ---
              mov ah, 0x00    ; KEY INPUT
              int 0x18        ; AH=Scan, AL=ASCII
              
              cmp al, 0x0D    ; Enter (CR) ?
              jne wait_enter

          shutdown:
              ; --- 画面を消して停止 ---
              mov ah, 0x16    ; Clear Screen
              mov dx, 0
              int 0x18

              ; システム停止
              cli
              hlt
          hlt_loop:
              jmp hlt_loop

          ; --- ウェイトルーチン ---
          delay_char:
              push cx
              mov cx, 0x4000  ; 待機カウント (エミュレータに合わせて調整)
          d1:
              push cx
              mov cx, 0x0005
          d2:
              loop d2
              pop cx
              loop d1
              pop cx
              ret

          section .data
          ; メッセージデータ
          message_data:
              db "YUKI.N> これをあなたが読んでいる時、", 0x0D, 0x0A
              db "わたしはわたしではないだろう。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このメッセージが表示されたということは、", 0x0D, 0x0A
              db "そこには、あなた、わたし、涼宮ハルヒ、朝比奈みくる、", 0x0D, 0x0A
              db "古泉一樹が存在しているはずである。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> それが鍵。", 0x0D, 0x0A
              db "あなたは解答を見つけ出した。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> これは緊急脱出プログラムである。", 0x0D, 0x0A
              db "起動させる場合はエンターキーを、", 0x0D, 0x0A
              db "そうでない場合はそれ以外のキーを選択せよ。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> 起動させた場合、", 0x0D, 0x0A
              db "あなたは時空修正の機会を得る。", 0x0D, 0x0A
              db "ただし成功は保証できない。", 0x0D, 0x0A
              db "また帰還の保証もできない。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このプログラムが起動するのは一度きりである。", 0x0D, 0x0A
              db "実行ののち、消去される。", 0x0D, 0x0A
              db "非実行が選択された場合は起動せずに消去される。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "Ready?", 0
          EOF

      - name: Convert Encoding (UTF-8 to Shift_JIS)
        run: |
          iconv -f UTF-8 -t SHIFT-JIS source_utf8.asm -o yuki.asm

      - name: Assemble
        run: |
          nasm yuki.asm -f bin -o yuki.bin

      - name: Create Floppy Image (2HD Raw)
        run: |
          python3 - <<EOF
          # PC-98 2HD Format (1.2MB approx)
          # 1024 bytes/sector, 8 sectors/track, 2 heads, 77 cylinders
          disk_size = 1261568
          
          with open('yuki.bin', 'rb') as f:
              code = f.read()
          
          # パディング (ディスクサイズまで0で埋める)
          if len(code) > disk_size:
              print("Warning: Code is larger than disk size!")
          
          padding = b'\x00' * (disk_size - len(code))
          
          with open('YUKI_N.fdi', 'wb') as f:
              f.write(code)
              f.write(padding)
              
          print(f"Created YUKI_N.fdi with size {disk_size} bytes")
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YUKI_N_FDI_Fixed
          path: YUKI_N.fdi
