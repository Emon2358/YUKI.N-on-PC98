name: Build PC-98 Japanese Direct VRAM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Create Assembly Source
        run: |
          cat << 'EOF' > source_utf8.asm
          cpu 8086
          org 0x0000

          section .text
          start:
              cli
              mov ax, cs
              mov ds, ax
              mov ss, ax
              mov sp, 0xFFFE
              sti

              ; --- 1. 画面モード初期化 (BIOS) ---
              ; 解像度設定だけはBIOSに任せるのが安全です
              mov ah, 0x0A
              mov al, 0x00    ; 400ラインモード
              int 0x18

              ; --- 2. 画面の色設定 (Direct VRAM A200) ---
              ; BIOSを使わず、属性メモリを直接塗りつぶします
              mov ax, 0xA200
              mov es, ax      ; ES = Attribute VRAM
              xor di, di
              mov cx, 4000    ; 80文字 x 25行 x 2バイト = 4000
              mov al, 0xE1    ; 属性: 背景=青(E), 文字=白(1)
              rep stosb

              ; --- 3. 画面の文字消去 (Direct VRAM A000) ---
              mov ax, 0xA000
              mov es, ax      ; ES = Character Code VRAM
              xor di, di
              mov cx, 4000
              mov al, 0x20    ; Space
              rep stosb

              ; --- 4. カーソルを消す ---
              mov ah, 0x13
              mov dx, 0       ; OFF
              int 0x18

              ; --- 5. 文字列表示 (Direct VRAM Loop) ---
              mov ax, 0xA000
              mov es, ax      ; ESを文字VRAMに戻す
              xor di, di      ; 画面左上(0)から
              mov si, message_data

          print_loop:
              lodsb           ; 文字読み込み (AL = char)
              or al, al       ; 終了(0)チェック
              jz wait_loop

              ; 改行コードチェック (0x0D = CR)
              cmp al, 0x0D
              je handle_newline
              cmp al, 0x0A    ; 0x0A(LF)は無視
              je print_loop

              ; VRAMへ書き込み
              stosb           ; [ES:DI] = AL, DI++
              
              ; 演出用ウェイト
              call delay
              jmp print_loop

          handle_newline:
              ; 現在のDIの位置から、次の行の先頭を計算する
              ; PC-98のテキストVRAMは 1行 = 80バイト (偶数・奇数アドレス連続)
              
              mov ax, di
              mov cl, 80      ; 1行の幅
              div cl          ; AX / 80 -> AL=行数, AH=余り
              
              inc al          ; 次の行へ
              
              mov ah, 0
              mul cl          ; 行数 * 80 = 新しいアドレス
              mov di, ax      ; DI更新
              
              jmp print_loop

          wait_loop:
              cli
              hlt
              jmp wait_loop

          delay:
              push cx
              push ax
              mov cx, 0x5000  ; 表示スピード調整
          d1:
              nop
              loop d1
              pop ax
              pop cx
              ret

          section .data
          message_data:
              ; 日本語テキスト (Shift-JISに変換されて格納されます)
              db "YUKI.N> これをあなたが読んでいる時、", 0x0D
              db "わたしはわたしではないだろう。", 0x0D
              db 0x0D
              db "YUKI.N> このメッセージが表示されたということは、", 0x0D
              db "そこには、あなた、わたし、涼宮ハルヒ、朝比奈みくる、", 0x0D
              db "古泉一樹が存在しているはずである。", 0x0D
              db 0x0D
              db "YUKI.N> それが鍵。", 0x0D
              db "あなたは解答を見つけ出した。", 0x0D
              db 0x0D
              db "YUKI.N> これは緊急脱出プログラムである。", 0x0D
              db "起動させる場合はエンターキーを、", 0x0D
              db "そうでない場合はそれ以外のキーを選択せよ。", 0x0D
              db 0x0D
              db "YUKI.N> 起動させた場合、", 0x0D
              db "あなたは時空修正の機会を得る。", 0x0D
              db "ただし成功は保証できない。", 0x0D
              db "また帰還の保証もできない。", 0x0D, 0x0D
              db "Ready?", 0
          EOF

      - name: Convert Encoding to Shift-JIS
        # 【重要】ソースコードをShift-JISに変換します
        # これをやらないと、VRAMに正しい値が入らず文字化けします
        run: iconv -f UTF-8 -t CP932 source_utf8.asm -o yuki.asm

      - name: Assemble
        run: nasm yuki.asm -f bin -o yuki.bin

      - name: Create HDM Image
        run: |
          python3 - <<EOF
          disk_size = 1261568
          with open('yuki.bin', 'rb') as f:
              code = f.read()
          padding = b'\x00' * (disk_size - len(code))
          with open('YUKI_N.hdm', 'wb') as f:
              f.write(code)
              f.write(padding)
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YUKI_N_JP_Direct
          path: YUKI_N.hdm
