name: Build PC-98 HDM Image

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Create Assembly Source
        run: |
          cat << 'EOF' > source_utf8.asm
          cpu 8086
          org 0x0000

          section .text
          start:
              ; --- セグメント初期化 (IPLロード位置 1FC0:0000) ---
              cli
              mov ax, cs
              mov ds, ax
              mov es, ax
              mov ss, ax
              mov sp, 0xFFFE
              sti

              ; --- 画面モードのリセット ---
              mov ah, 0x0A
              mov al, 0x00    ; 400ラインモード
              int 0x18

              ; --- VRAMクリア ---
              mov ah, 0x16
              mov dx, 0
              int 0x18

              ; --- カーソル設定 ---
              mov ah, 0x13
              mov dx, 1       ; 表示ON
              mov cx, 0x0000
              int 0x18
              
              ; --- 【重要】文字色の強制設定 ---
              ; 黒背景・白文字(0xE1) で画面全体を塗りつぶす
              push es
              mov ax, 0xA200
              mov es, ax
              xor di, di
              mov cx, 4000    ; 80x25x2bytes
              mov al, 0xE1
              rep stosb
              pop es

              ; --- メッセージ表示 ---
              mov si, message_data
          
          char_loop:
              lodsb
              or al, al
              jz wait_enter

              ; BIOSで一文字出力
              mov ah, 0x40
              mov bx, 0
              int 0x18
              
              call delay_char
              jmp char_loop

          wait_enter:
              mov ah, 0x00
              int 0x18
              cmp al, 0x0D
              jne wait_enter

          shutdown:
              mov ah, 0x16
              mov dx, 0
              int 0x18
              cli
              hlt
          hlt_loop:
              jmp hlt_loop

          delay_char:
              push cx
              mov cx, 0x3000
          d1:
              push cx
              mov cx, 0x0005
          d2:
              loop d2
              pop cx
              loop d1
              pop cx
              ret

          section .data
          message_data:
              db "YUKI.N> これをあなたが読んでいる時、", 0x0D, 0x0A
              db "わたしはわたしではないだろう。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このメッセージが表示されたということは、", 0x0D, 0x0A
              db "そこには、あなた、わたし、涼宮ハルヒ、朝比奈みくる、", 0x0D, 0x0A
              db "古泉一樹が存在しているはずである。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> それが鍵。", 0x0D, 0x0A
              db "あなたは解答を見つけ出した。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> これは緊急脱出プログラムである。", 0x0D, 0x0A
              db "起動させる場合はエンターキーを、", 0x0D, 0x0A
              db "そうでない場合はそれ以外のキーを選択せよ。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> 起動させた場合、", 0x0D, 0x0A
              db "あなたは時空修正の機会を得る。", 0x0D, 0x0A
              db "ただし成功は保証できない。", 0x0D, 0x0A
              db "また帰還の保証もできない。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このプログラムが起動するのは一度きりである。", 0x0D, 0x0A
              db "実行ののち、消去される。", 0x0D, 0x0A
              db "非実行が選択された場合は起動せずに消去される。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "Ready?", 0
          EOF

      - name: Convert Encoding
        run: iconv -f UTF-8 -t SHIFT-JIS source_utf8.asm -o yuki.asm

      - name: Assemble
        run: nasm yuki.asm -f bin -o yuki.bin

      - name: Create HDM Image (Standard Raw)
        # Neko Project IIが最も確実に認識する「Raw形式(.hdm)」を作成します。
        # サイズを厳密に 1,261,568 bytes (2HD) にすることで、
        # エミュレータはファイルヘッダ無しでもフロッピーとして認識します。
        run: |
          python3 - <<EOF
          disk_size = 1261568
          
          with open('yuki.bin', 'rb') as f:
              code = f.read()
          
          padding = b'\x00' * (disk_size - len(code))
          
          # 拡張子を .hdm にします
          with open('YUKI_N.hdm', 'wb') as f:
              f.write(code)
              f.write(padding)
              
          print(f"Created YUKI_N.hdm (Size: {disk_size})")
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YUKI_N_HDM
          path: YUKI_N.hdm
