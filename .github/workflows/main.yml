name: Build PC-98 D88 (No Reset Needed)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Create Assembly Source
        # 起動直後に画面の色設定を強制的に上書きし、黒画面バグを回避します
        run: |
          cat << 'EOF' > source_utf8.asm
          cpu 8086
          org 0x0000

          section .text
          start:
              ; --- セグメントの安全な初期化 ---
              cli
              mov ax, cs
              mov ds, ax
              mov es, ax
              mov ss, ax
              mov sp, 0xFFFE
              sti

              ; --- 起動確認音 (ピポッ) ---
              ; 画面が真っ暗でも、音が鳴れば「動いている」とわかります
              mov ah, 0x18
              mov dx, 0
              int 0x18

              ; --- 画面モードの強制リセット ---
              mov ah, 0x0A
              mov al, 0x00    ; 400ラインモード
              int 0x18

              ; --- VRAM全消去 ---
              mov ah, 0x16
              mov dx, 0
              int 0x18

              ; --- カーソル表示 ---
              mov ah, 0x13
              mov dx, 1       ; 表示ON
              mov cx, 0x0000
              int 0x18
              
              ; --- テキスト色を「白」に強制固定 ---
              ; 一部のエミュレータで文字色が黒になるのを防ぐため
              ; テキストアトリビュート領域(A200:0000)を直接書き換えます
              push es
              mov ax, 0xA200  ; テキスト属性セグメント
              mov es, ax
              xor di, di      ; オフセット 0
              mov cx, 4000    ; 画面全体分
              mov al, 0xE1    ; 属性: 背景=青(E), 文字=白(1)
              rep stosb       ; 書き込み実行
              pop es

              ; --- メッセージ表示 ---
              mov si, message_data
          
          char_loop:
              lodsb
              or al, al
              jz wait_enter

              ; BIOSで文字出力
              mov ah, 0x40
              mov bx, 0
              int 0x18
              
              call delay_char
              jmp char_loop

          wait_enter:
              mov ah, 0x00
              int 0x18
              cmp al, 0x0D
              jne wait_enter

          shutdown:
              mov ah, 0x16
              mov dx, 0
              int 0x18
              cli
              hlt
          hlt_loop:
              jmp hlt_loop

          delay_char:
              push cx
              mov cx, 0x3000
          d1:
              push cx
              mov cx, 0x0005
          d2:
              loop d2
              pop cx
              loop d1
              pop cx
              ret

          section .data
          message_data:
              db "YUKI.N> これをあなたが読んでいる時、", 0x0D, 0x0A
              db "わたしはわたしではないだろう。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このメッセージが表示されたということは、", 0x0D, 0x0A
              db "そこには、あなた、わたし、涼宮ハルヒ、朝比奈みくる、", 0x0D, 0x0A
              db "古泉一樹が存在しているはずである。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> それが鍵。", 0x0D, 0x0A
              db "あなたは解答を見つけ出した。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> これは緊急脱出プログラムである。", 0x0D, 0x0A
              db "起動させる場合はエンターキーを、", 0x0D, 0x0A
              db "そうでない場合はそれ以外のキーを選択せよ。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> 起動させた場合、", 0x0D, 0x0A
              db "あなたは時空修正の機会を得る。", 0x0D, 0x0A
              db "ただし成功は保証できない。", 0x0D, 0x0A
              db "また帰還の保証もできない。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このプログラムが起動するのは一度きりである。", 0x0D, 0x0A
              db "実行ののち、消去される。", 0x0D, 0x0A
              db "非実行が選択された場合は起動せずに消去される。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "Ready?", 0
          EOF

      - name: Convert Encoding
        run: iconv -f UTF-8 -t SHIFT-JIS source_utf8.asm -o yuki.asm

      - name: Assemble
        run: nasm yuki.asm -f bin -o yuki.bin

      - name: Create D88 Disk Image
        # エミュレータが確実に認識するD88ヘッダを付与します
        run: |
          python3 - <<EOF
          import struct
          
          # D88形式のヘッダ (688バイト)
          header = bytearray(688)
          
          # ディスク名 (16バイト)
          disk_name = b"YUKI_N_BOOT"
          header[0:len(disk_name)] = disk_name
          
          # 0x1A: ライトプロテクトなし(00)
          # 0x1B: メディア種別 2HD (20)
          header[0x1B] = 0x20
          
          # 0x1C: ディスクサイズ (4バイト)
          disk_size = 688 + 1261568  # ヘッダ + データ
          struct.pack_into('<I', header, 0x1C, disk_size)
          
          # トラックポインタテーブル (簡易的にすべて0詰めでも多くのエミュは読むが、念のため)
          # np2 wasmはヘッダさえあればRawとして読んでくれることが多い
          
          # バイナリデータの準備
          with open('yuki.bin', 'rb') as f:
              code = f.read()
              
          # ディスクデータ本体 (2HD = 1,261,568 bytes)
          raw_disk = bytearray(1261568)
          raw_disk[0:len(code)] = code
          
          with open('YUKI_N.d88', 'wb') as f:
              f.write(header)
              f.write(raw_disk)
              
          print("Created YUKI_N.d88")
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YUKI_N_D88
          path: YUKI_N.d88
