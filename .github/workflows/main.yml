name: Build PC-98 English Interface (No Mojibake)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Create Assembly Source
        run: |
          cat << 'EOF' > source_utf8.asm
          cpu 8086
          org 0x0000

          section .text
          start:
              cli
              mov ax, cs
              mov ds, ax
              mov es, ax
              mov ss, ax
              mov sp, 0xFFFE
              sti

              ; --- 画面設定 ---
              mov ah, 0x0A
              mov al, 0x00    ; 400ラインモード
              int 0x18

              ; --- VRAM直接操作で画面をクリア ---
              ; BIOSに頼らず、メモリを直接書き換えることで確実に表示させます
              
              ; 1. 文字コード領域(A000)をスペースで埋める
              mov ax, 0xA000
              mov es, ax
              xor di, di
              mov cx, 2000    ; 2000文字分
              mov al, 0x20    ; Space
              rep stosb

              ; 2. 属性領域(A200)を「青背景・白文字」で埋める
              mov ax, 0xA200
              mov es, ax
              xor di, di
              mov cx, 2000
              mov al, 0xE1    ; Blue Background, White Text
              rep stosb

              ; --- カーソルを消す ---
              mov ah, 0x13
              mov dx, 0       ; OFF
              int 0x18

              ; --- メッセージ表示開始 ---
              ; ダイレクトVRAM書き込みで行います
              
              mov ax, 0xA000  ; 文字領域
              mov es, ax
              xor di, di      ; 画面左上(0)からスタート
              
              mov si, message_data

          print_char:
              lodsb           ; 文字を1つ読み込む
              or al, al       ; 0(終了)かチェック
              jz ready_prompt

              cmp al, 0x0D    ; 改行コードチェック
              je new_line

              ; 文字をVRAMに書き込む
              stosb
              
              ; タイプライター風の演出ウェイト
              call delay
              jmp print_char

          new_line:
              ; 改行処理: 現在のDI位置から次の行の先頭へ
              ; PC-98の1行は80バイト(偶数アドレスのみ使うわけではないので80)
              ; 正確には A000セグメントでは連続しているので、次の80の倍数へ飛ばす
              
              mov ax, di
              mov cl, 80
              div cl          ; AX / 80 -> AL=行数, AH=余り
              
              ; 現在の行数 + 1
              inc al
              
              ; 新しいオフセット = (行数 * 80)
              mov AH, 0
              mul cl
              mov di, ax
              
              jmp print_char

          ready_prompt:
              ; 入力待ちループ
              cli
              hlt
              jmp ready_prompt

          delay:
              push cx
              push ax
              mov cx, 0x6000  ; 少しゆっくり表示
          d_loop:
              nop
              loop d_loop
              pop ax
              pop cx
              ret

          section .data
          message_data:
              db "YUKI.N> If you are reading this,", 0x0D
              db "YUKI.N> it means I am no longer me.", 0x0D
              db 0x0D
              db "YUKI.N> The presence of this message implies", 0x0D
              db "YUKI.N> that you, I, Haruhi Suzumiya, Mikuru Asahina,", 0x0D
              db "YUKI.N> and Itsuki Koizumi are all here.", 0x0D
              db 0x0D
              db "YUKI.N> That is the key.", 0x0D
              db "YUKI.N> You have found the answer.", 0x0D
              db 0x0D
              db "YUKI.N> This is an emergency escape program.", 0x0D
              db "YUKI.N> Press ENTER to launch.", 0x0D
              db "YUKI.N> Otherwise, select any other key.", 0x0D
              db 0x0D
              db "Ready?", 0
          EOF

      - name: Assemble
        run: nasm source_utf8.asm -f bin -o yuki.bin

      - name: Create HDM Image (Correct Size)
        run: |
          python3 - <<EOF
          disk_size = 1261568
          with open('yuki.bin', 'rb') as f:
              code = f.read()
          padding = b'\x00' * (disk_size - len(code))
          with open('YUKI_N.hdm', 'wb') as f:
              f.write(code)
              f.write(padding)
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YUKI_N_English
          path: YUKI_N.hdm
