name: Build PC-98 Japanese Native (Fix Mojibake)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Create Assembly Source (UTF-8)
        run: |
          cat << 'EOF' > source_utf8.asm
          cpu 8086
          org 0x0000

          section .text
          start:
              ; --- セグメント初期化 ---
              cli
              mov ax, cs
              mov ds, ax
              mov es, ax
              mov ss, ax
              mov sp, 0xFFFE
              sti

              ; --- 画面モード設定 (400ライン・日本語モード) ---
              mov ah, 0x0A
              mov al, 0x00
              int 0x18

              ; --- 画面クリア ---
              mov ah, 0x16
              mov dx, 0
              int 0x18

              ; --- カーソル表示ON ---
              mov ah, 0x13
              mov dx, 1
              mov cx, 0x0000
              int 0x18

              ; --- 背景色設定 (青背景・白文字) ---
              ; 日本語を表示するためには、属性VRAMをBIOS経由ではなく
              ; 直接設定するのが最も確実です（BIOSだと色設定が複雑なため）
              
              push es
              mov ax, 0xA200  ; テキスト属性セグメント
              mov es, ax
              xor di, di
              mov cx, 4000    ; 画面全体 (80文字x25行x2バイト)
              mov al, 0xE1    ; 背景=青(E), 文字=白(1)
              rep stosb
              pop es

              ; --- 日本語メッセージ表示 (BIOS使用) ---
              ; PC-98のBIOS(INT 18h)はShift-JISを正しく解釈します
              mov si, message_data
          
          char_loop:
              lodsb           ; 1バイト読み込み
              or al, al       ; 終了判定
              jz wait_enter

              ; 日本語(2バイト文字)判定
              ; Shift-JISの1バイト目は 0x81-0x9F または 0xE0-0xFC
              ; これを判定して、2バイト文字なら続けてもう1バイト読みます
              
              mov ah, 0x40    ; BIOS出力用コード初期化
              
              ; 簡易判定: 0x80以上なら2バイト文字の1バイト目とみなす
              cmp al, 0x80
              jb print_single

              ; 2バイト文字の場合
              mov ah, al      ; 1バイト目をAHへ
              lodsb           ; 2バイト目をALへ読み込む

          print_single:
              ; ここで AX に文字コードが入っている (1バイト文字ならALのみ、2バイトならAH+AL)
              ; 1バイト文字の場合、BIOSには AH=0x40, AL=文字 ではなく
              ; 2バイトコードとして渡す必要がある場合があるが、
              ; INT 18h AH=40h は本来「文字列書き込み」用ではなく単純出力には向かない場合がある
              ; 最も安全な「一文字出力」である AH=0x40 を使うには工夫が必要
              
              ; --- シンプルなBIOS出力 ---
              mov dx, ax      ; DXにデータを入れる（BIOSの仕様によってはDXを使う）
              mov ah, 0x40    ; 一文字表示コマンド
              mov bx, 0
              int 0x18        ; 表示実行

              call delay_char
              jmp char_loop

          wait_enter:
              ; 入力待ち
              mov ah, 0x00
              int 0x18
              cmp al, 0x0D    ; Enterキー
              jne wait_enter

          shutdown:
              hlt

          delay_char:
              push cx
              mov cx, 0x4000
          d1:
              loop d1
              pop cx
              ret

          section .data
          message_data:
              ; ここの日本語は次のステップでShift-JISに変換されます
              db "YUKI.N> これをあなたが読んでいる時、", 0x0D, 0x0A
              db "わたしはわたしではないだろう。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このメッセージが表示されたということは、", 0x0D, 0x0A
              db "そこには、あなた、わたし、涼宮ハルヒ、朝比奈みくる、", 0x0D, 0x0A
              db "古泉一樹が存在しているはずである。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> それが鍵。", 0x0D, 0x0A
              db "あなたは解答を見つけ出した。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> これは緊急脱出プログラムである。", 0x0D, 0x0A
              db "起動させる場合はエンターキーを、", 0x0D, 0x0A
              db "そうでない場合はそれ以外のキーを選択せよ。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> 起動させた場合、", 0x0D, 0x0A
              db "あなたは時空修正の機会を得る。", 0x0D, 0x0A
              db "ただし成功は保証できない。", 0x0D, 0x0A
              db "また帰還の保証もできない。", 0x0D, 0x0A
              db 0x0D, 0x0A
              db "YUKI.N> このプログラムが起動するのは一度きりである。", 0x0D, 0x0A
              db "実行ののち、消去される。", 0x0D, 0x0A
              db "Ready?", 0
          EOF

      - name: Convert Encoding to Shift-JIS
        # ここでUTF-8のソースコードをPC-98用のShift-JIS(CP932)に変換します
        # これにより文字化けを防ぎます
        run: iconv -f UTF-8 -t CP932 source_utf8.asm -o yuki.asm

      - name: Assemble
        run: nasm yuki.asm -f bin -o yuki.bin

      - name: Create HDM Image
        run: |
          python3 - <<EOF
          disk_size = 1261568
          with open('yuki.bin', 'rb') as f:
              code = f.read()
          padding = b'\x00' * (disk_size - len(code))
          with open('YUKI_N.hdm', 'wb') as f:
              f.write(code)
              f.write(padding)
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YUKI_N_Japanese
          path: YUKI_N.hdm
