name: Build PC-98 Force Display (English/HDM)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Create Assembly Source
        run: |
          cat << 'EOF' > source_utf8.asm
          cpu 8086
          org 0x0000

          section .text
          start:
              cli
              mov ax, cs
              mov ds, ax
              mov es, ax
              mov ss, ax
              mov sp, 0xFFFE
              sti

              ; --- 1. 起動音 (動いているかの確認) ---
              mov ah, 0x18
              mov dx, 0
              int 0x18

              ; --- 2. 画面モード初期化 ---
              mov ah, 0x0A
              mov al, 0x00    ; 400ライン
              int 0x18

              ; --- 3. 画面を「青背景・白文字」で埋め尽くす ---
              ; BIOSのclsではなく、直接メモリを書き換えて色を強制します
              
              ; テキストVRAM (文字コード) のクリア
              mov ax, 0xA000
              mov es, ax
              xor di, di
              mov cx, 2000    ; 2000文字分
              mov al, 0x20    ; スペース
              rep stosb

              ; テキスト属性 (色) の強制設定
              mov ax, 0xA200
              mov es, ax
              xor di, di
              mov cx, 2000
              ; 属性バイト: 0xE1 (背景=青, 文字=白, 点滅なし)
              ; これで画面全体が「青く」なるはずです
              mov al, 0xE1    
              rep stosb

              ; --- 4. 文字を表示 (英語のみ) ---
              ; 漢字ROMがない可能性を考慮し、ASCIIだけで書きます
              mov si, message_data
              mov di, 0       ; 画面左上から
              
              ; セグメント設定: ES=0xA000 (文字VRAM)
              mov ax, 0xA000
              mov es, ax

          print_loop:
              lodsb           ; 文字読み込み
              or al, al
              jz halt_loop    ; 0なら終了

              cmp al, 0x0D    ; 改行(CR)処理
              je newline
              cmp al, 0x0A    ; 改行(LF)無視
              je print_loop

              stosb           ; VRAMに書き込み (ES:DI)
              
              ; ウェイト（文字が流れる演出）
              call delay
              jmp print_loop

          newline:
              ; 次の行へ (PC-98は1行80文字=80バイト)
              ; DIの値を次の80の倍数まで進める簡易処理
              mov ax, di
              mov cl, 80
              div cl          ; AX / 80 -> AL=行数, AH=余り
              inc al          ; 次の行
              mul cl          ; 行数 * 80
              mov di, ax      ; 新しい位置
              jmp print_loop

          halt_loop:
              cli
              hlt
              jmp halt_loop

          delay:
              push cx
              mov cx, 0x4000
          d1:
              loop d1
              pop cx
              ret

          section .data
          message_data:
              db "YUKI.N> Reading this means I am no longer me.", 0x0D
              db 0x0D
              db "YUKI.N> This message is an emergency escape program.", 0x0D
              db "YUKI.N> Press ENTER to activate.", 0x0D
              db 0x0D
              db "YUKI.N> Good luck.", 0x0D
              db 0x00
          EOF

      - name: Assemble
        run: nasm source_utf8.asm -f bin -o yuki.bin

      - name: Create HDM Image
        run: |
          python3 - <<EOF
          disk_size = 1261568
          with open('yuki.bin', 'rb') as f:
              code = f.read()
          padding = b'\x00' * (disk_size - len(code))
          with open('YUKI_N.hdm', 'wb') as f:
              f.write(code)
              f.write(padding)
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YUKI_N_HDM_ForceBlue
          path: YUKI_N.hdm
